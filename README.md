# Systolic Array for Efficient Attention Computation

This repository contains the code for the project in the course CS242: Computing at Scale at Harvard. It is a systolic array implementation of the attention mechanism found in transformer models. 

The `rtl` sub-directory contains the RTL written in System Verilog.
The `tb` sub-directory contains the test bench written in C++ and simulated using Verilator.
The `error_analysis` sub-directory contains C++ code that computes the error in the Taylor approximation of the exponent. It is also simulated using Verilator.

## Running the code

To simulate the testbench or error analysis, by generating random matrices, driving the DUT ports, and displaying the result matrix generated by the DUT.

### 1. Requirements: 
- `Verilator`
- `GNU Make`


### 2. Clone the repository:
```
git clone git@github.com:olavforland/CS242-Systolic-Arrays-for-Efficient-Attention-Computation.git
```
### 3. Run the simulation:

By default the RTL and TB are configured to a matrix size of 32x32.

**Parameters**
- N: Sequence length of Q, K, and V matrices (default 32)
- d: Representation dimension of Q, K, and V matrices (default 32)
- K: Number of terms in the Taylor approximation (default 10)

```
cd tb
make all [N=N] [d=d] [K=K]
```

### 4. Run the error analysis:

The error analysis compiles and runs the Attention Systolic Array for values of K and scale of Q, K, V. 
The scaling and values of K to test for is given in `error_analysis/run_tests.sh`.

**Parameters**
- N: Sequence length of Q, K, and V matrices (default 32)
- d: Representation dimension of Q, K, and V matrices (default 32)

```
cd tb
make all [N=N] [d=d]
```

### 5. Run QK distribution analysis:

Generates random input ids for a transformer to generate Q,K,V matrices and empircally obtain the distribution of
$QK^\top/\sqrt{d}$ entries to further bound error of Taylor approximation.

**Parameters**
- mode: attention/qk (attention used to get distribution of attention scores, qk used to get distribution of
$QK^\top/\sqrt{d}$)
- model: gpt2/bert-base-uncased (default: bert-base-uncased)

```
cd qk_dist
python3 qk_dist.py [mode] [model]
```

## Acknowledgements

The repository structure was influenced by the work from the repository [2D-Systolic-Array-Multiplier](https://github.com/tms4517/2D-Systolic-Array-Multiplier). He's System Verilog code for output-stationary systolic arrays was a great starting point when we had no background in HDS. Also, we still use his implementation of the testbench. Thank you!

